# 架构设计文档

## 1. 系统架构概述

### 1.1 架构风格

本项目采用**微服务架构**，基于 **Spring Cloud Alibaba** 生态，遵循 **DDD（领域驱动设计）** 思想，实现服务拆分、低耦合、高内聚的设计目标。

### 1.2 技术架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway (8080)                      │
│                  Spring Cloud Gateway                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌─────▼──────┐ ┌────▼──────┐
│ Auth Service │ │User Service│ │Product Svc│
│   (8081)     │ │   (8082)   │ │  (8083)   │
└──────────────┘ └────────────┘ └───────────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌─────▼──────┐ ┌────▼──────┐
│Report Service│ │ DFS Service│ │  Nacos   │
│   (8084)     │ │   (8085)   │ │  (8848)  │
└──────────────┘ └────────────┘ └──────────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌─────▼──────┐ ┌────▼──────┐
│  PostgreSQL  │ │   Redis    │ │ RabbitMQ  │
│  (多数据库)   │ │  (缓存)    │ │  (消息)   │
└──────────────┘ └────────────┘ └───────────┘
```

## 2. 服务拆分设计

### 2.1 服务划分原则

1. **业务边界清晰**：按业务领域划分服务，每个服务负责一个明确的业务领域
2. **数据独立**：每个服务拥有独立的数据库，通过服务前缀区分表名
3. **低耦合高内聚**：服务间通过 API 调用，避免直接数据库访问
4. **可独立部署**：每个服务可独立开发、测试、部署

### 2.2 服务列表

| 服务名称 | 端口 | 职责 | 数据库前缀 |
|---------|------|------|-----------|
| gateway-service | 8080 | API 网关，统一入口 | - |
| auth-service | 8081 | 认证鉴权服务 | auth_ |
| user-service | 8082 | 用户管理服务 | user_ |
| product-service | 8083 | 商品管理服务 | product_ |
| report-service | 8084 | 报表管理服务 | report_ |
| dfs-service | 8085 | 文件服务 | dfs_ |

## 3. DDD 分层架构

### 3.1 分层结构

每个服务模块都采用 DDD 分层架构：

```
service-name/
├── common/              # 公共模块（跨层共享）
│   ├── constants/       # 常量类
│   ├── enums/           # 枚举类
│   ├── exception/       # 异常处理
│   └── result/          # 统一响应格式
├── domain/              # 领域层（业务领域模型）
│   ├── entity/          # 实体
│   ├── repository/      # 仓储接口
│   ├── service/         # 领域服务
│   └── event/           # 领域事件
├── application/         # 应用层（业务逻辑编排）
│   ├── command/         # 命令（CQRS）
│   ├── query/           # 查询（CQRS）
│   ├── dto/             # 数据传输对象
│   └── service/         # 应用服务
├── infrastructure/      # 基础设施层（技术实现）
│   ├── repository/       # 仓储实现
│   ├── config/          # 配置类
│   ├── mq/              # 消息队列
│   └── job/             # 定时任务
└── interfaces/          # 接口层（对外 API）
    └── rest/            # REST 接口
```

### 3.2 依赖规则

- **Common 层**：不依赖任何其他层，可被所有层使用
- **Domain 层**：只依赖 Common 层，不依赖其他业务层
- **Application 层**：依赖 Domain 层和 Common 层
- **Infrastructure 层**：依赖 Domain 层和 Common 层，实现技术细节
- **Interfaces 层**：依赖 Application 层、Domain 层和 Common 层

### 3.3 CQRS 模式

采用 **命令查询职责分离（CQRS）** 模式：

- **Command（命令）**：用于修改数据，位于 `application/command/`
- **Query（查询）**：用于查询数据，位于 `application/query/`
- 命令和查询分离，提高系统的可扩展性和性能

## 4. 技术栈详解

### 4.1 服务注册与发现

- **Nacos**：作为服务注册中心，所有服务注册到 Nacos
- **服务发现**：通过服务名进行服务发现，支持负载均衡

### 4.2 配置管理

- **Nacos Config**：作为配置中心，统一管理各服务配置
- **配置格式**：`{service-name}-{profile}.yml`
- **共享配置**：公共配置放在 `common-config.yml`

### 4.3 API 网关

- **Spring Cloud Gateway**：统一入口，路由转发
- **功能**：认证拦截、限流熔断、日志记录、请求转发

### 4.4 服务调用

- **OpenFeign**：声明式服务调用
- **负载均衡**：Spring Cloud LoadBalancer
- **请求拦截**：自动传递 Token 等请求头

### 4.5 消息队列

- **RabbitMQ**：异步消息处理
- **使用场景**：事件驱动、异步任务、解耦服务

### 4.6 任务调度

- **XXL-Job**：分布式任务调度
- **使用场景**：定时任务、报表生成、数据同步

### 4.7 缓存

- **Redis**：分布式缓存
- **使用场景**：Token 存储、数据缓存、分布式锁

## 5. 数据库设计

### 5.1 数据库隔离

所有服务共用同一个逻辑数据库：

- `demo_cloud`：存放所有服务的数据，通过表前缀实现逻辑隔离

### 5.2 表命名规范

每个服务的表名使用服务前缀：

- 认证服务：`auth_user`, `auth_role`, `auth_permission`
- 用户服务：`user_info`, `user_config`
- 商品服务：`product_info`, `product_type`
- 报表服务：`report_template`, `report_data`
- 文件服务：`dfs_file`

### 5.3 基础字段

所有表都包含以下基础字段：

- `id`：主键（32位随机字符）
- `create_date`：创建时间
- `create_user`：创建用户
- `update_date`：更新时间
- `update_user`：更新用户
- `deleted`：逻辑删除标记（0-未删除，1-已删除）
- `db_version`：版本号（乐观锁）

## 6. 安全设计

### 6.1 认证机制

- **JWT Token**：基于 JWT 的无状态认证
- **Token 存储**：Token 存储在 Redis 中，支持过期和刷新
- **Token 传递**：通过请求头 `Authorization: Bearer {token}` 传递

### 6.2 权限控制

- **RBAC 模型**：基于角色的访问控制
- **权限验证**：在网关层进行权限验证
- **服务间调用**：通过 Feign 自动传递 Token

## 7. 高可用设计

### 7.1 服务高可用

- **多实例部署**：每个服务可部署多个实例
- **负载均衡**：通过 Nacos 和 LoadBalancer 实现负载均衡
- **健康检查**：Nacos 自动进行健康检查

### 7.2 数据高可用

- **数据库主从**：支持数据库主从复制
- **缓存集群**：Redis 支持集群模式
- **消息队列集群**：RabbitMQ 支持集群模式

## 8. 监控与运维

### 8.1 日志管理

- **统一日志格式**：所有服务使用统一的日志格式
- **日志收集**：建议使用 ELK 或类似工具收集日志
- **链路追踪**：建议集成 SkyWalking 或 Zipkin

### 8.2 监控指标

- **服务监控**：通过 Spring Boot Actuator 暴露监控指标
- **业务监控**：自定义业务指标监控
- **告警机制**：集成告警系统

## 9. 扩展性设计

### 9.1 水平扩展

- **无状态服务**：所有服务设计为无状态，支持水平扩展
- **数据库扩展**：支持数据库分库分表
- **缓存扩展**：Redis 支持集群扩展

### 9.2 功能扩展

- **模块化设计**：新功能可通过新增服务实现
- **插件化架构**：核心功能支持插件化扩展
- **版本管理**：支持 API 版本管理

## 10. 最佳实践

### 10.1 开发规范

1. **代码规范**：遵循阿里巴巴 Java 开发规范
2. **命名规范**：使用统一的命名规范
3. **注释规范**：关键代码必须添加注释

### 10.2 测试规范

1. **单元测试**：核心业务逻辑必须有单元测试
2. **集成测试**：服务间调用必须有集成测试
3. **接口测试**：所有 API 接口必须有接口测试

### 10.3 部署规范

1. **环境隔离**：开发、测试、生产环境严格隔离
2. **配置管理**：敏感配置使用配置中心管理
3. **版本管理**：使用版本号管理服务版本

